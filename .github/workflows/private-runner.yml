
name: Ephemeral GCP GitHub Runner

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: read
  id-token: write   # for OIDC to GCP
  actions: read

jobs:
  provision:
    runs-on: ubuntu-latest
    outputs:
      labels: ${{ steps.tf.outputs.runner_labels }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_ID_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: infra/gcp-runner
        env:
          TF_VAR_tf_state_bucket: ${{ secrets.GCS_TF_STATE_BUCKET }}
        run: terraform init

      - name: Terraform Apply (create runner VM)
        id: tf
        working-directory: infra/gcp-runner
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: "asia-south1"
          TF_VAR_zone: "asia-south1-a"
          TF_VAR_repo_owner: "AnugulaSharathKumar"   # <-- update if needed
          TF_VAR_repo_name: "Bilvanties_Task-3"     # <-- update if needed
          TF_VAR_github_pat_secret: ${{ secrets.GITHUB_PAT_SECRET_NAME }}
          TF_VAR_tf_state_bucket: ${{ secrets.GCS_TF_STATE_BUCKET }}
        run: |
          terraform apply -auto-approve
          # expose labels to downstream job
          echo "runner_labels=$(terraform output -json runner_labels)" >> $GITHUB_OUTPUT

  build:
    needs: provision
    runs-on: [ self-hosted, gcp-gce, linux ]   # matches startup.sh labels
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Your actual workflow steps go here
      - name: Show runner info
        run: |
          uname -a
          echo "Labels: ${{ needs.provision.outputs.labels }}"

  cleanup:
    needs: [ provision, build ]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_ID_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Destroy (delete runner VM)
        working-directory: infra/gcp-runner
        env:
          TF_VAR_tf_state_bucket: ${{ secrets.GCS_TF_STATE_BUCKET }}
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
        run: terraform destroy -auto-approve