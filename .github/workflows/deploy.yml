name: GCP Self Hosted Runner – Full Lifecycle

on:
  push:
    branches:
      - main

jobs:
  deploy:
    # ====================================================
    # STEP A: RUNNER SELECTION
    # Purpose: GitHub finds ONLINE self-hosted runner
    # ====================================================
    runs-on: self-hosted

    steps:

      # ====================================================
      # STEP B: PIPELINE START CONFIRMATION
      # ====================================================
      - name: STEP B - Pipeline Started
        run: |
          echo "===================================="
          echo "$(date) : Pipeline started on runner"
          hostname
          whoami
          echo "===================================="


      # ====================================================
      # STEP C: CHECKOUT SOURCE CODE
      # ====================================================
      - name: STEP C - Checkout Repository
        uses: actions/checkout@v4


      # ====================================================
      # STEP D: DEPLOY APPLICATION
      # ====================================================
      - name: STEP D - Deploy Application
        run: |
          echo "$(date) : Deploying application"
          sudo systemctl restart nginx
          sudo systemctl status nginx


      # ====================================================
      # STEP E: VERIFY APPLICATION
      # ====================================================
      - name: STEP E - Verify Application
        run: |
          echo "$(date) : Verifying application"
          curl -I http://localhost


      # ====================================================
      # STEP F: SHUTDOWN VM
      # Purpose: Cost saving – stop runner after job
      # ====================================================
      - name: STEP F - Shutdown Runner VM
        run: |
          echo "===================================="
          echo "$(date) : Pipeline completed"
          echo "$(date) : Shutting down VM"
          echo "===================================="
          sudo shutdown -h now
