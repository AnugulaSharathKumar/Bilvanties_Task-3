
name: Start runner and execute job

on:
  push:
  workflow_dispatch:

# Minimal permissions for the Actions REST APIs and reading repo content
permissions:
  actions: write
  contents: read

env:
  INSTANCE_NAME: private-runner-instance
  ZONE: us-central1-a
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  # Use the same labels that your self-hosted runner config.sh will set on the VM
  EXPECTED_LABELS: self-hosted,linux,private

jobs:
  start-runner:
    runs-on: ubuntu-latest
    outputs:
      started: ${{ steps.start-instance.outcome }}
      runner_token: ${{ steps.reg.outputs.token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify GCP auth inputs
        run: |
          if [ -z "${{ secrets.GCP_WORKLOAD_ID_PROVIDER }}" ] && [ -z "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" ]; then
            echo "No GCP auth inputs configured. Configure either GCP_WORKLOAD_ID_PROVIDER+GCP_SERVICE_ACCOUNT_EMAIL (OIDC) or GCP_SERVICE_ACCOUNT_KEY (service account JSON) in repository secrets." >&2
            exit 1
          fi

      - name: Authenticate to GCP (OIDC)
        if: ${{ secrets.GCP_WORKLOAD_ID_PROVIDER != '' && secrets.GCP_SERVICE_ACCOUNT_EMAIL != '' }}
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_ID_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
          create_credentials_file: true
          export_environment_variables: true
          access_token_scopes: https://www.googleapis.com/auth/cloud-platform
          access_token_lifetime: 3600s
          cleanup_credentials: true
          universe: googleapis.com

      - name: Authenticate to GCP (service account key)
        if: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY != '' }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          create_credentials_file: true
          export_environment_variables: true
          access_token_scopes: https://www.googleapis.com/auth/cloud-platform
          access_token_lifetime: 3600s
          cleanup_credentials: true
          universe: googleapis.com

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Get runner registration token (repo-level)
        id: reg
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          echo "Requesting registration token for ${{ github.repository }}"

          TOKEN_JSON=$(curl -v -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/OWNER/${{ github.repository }}/actions/runners/registration-token")  

          REG_TOKEN=$(echo "${TOKEN_JSON}" | jq -r '.token')

          if [ -z "${REG_TOKEN}" ] || [ "${REG_TOKEN}" = "null" ]; then
            echo "Failed to get registration token" >&2
            echo "Response: ${TOKEN_JSON}" >&2
            exit 1
          fi

          echo "token=${REG_TOKEN}" >> "$GITHUB_OUTPUT"

      - name: Add metadata (runner_token + repo URL) to VM
        run: |
          set -euo pipefail
          gcloud compute instances add-metadata "$INSTANCE_NAME" \
            --metadata "runner_token=${{ steps.reg.outputs.token }},github_url=https://github.com/${{ github.repository }},runner_labels=${{ env.EXPECTED_LABELS }}" \
            --zone "$ZONE" --project "$PROJECT_ID"

      - name: Start instance
        id: start-instance
        run: |
          set -euo pipefail
          gcloud compute instances start "$INSTANCE_NAME" --zone "$ZONE" --project "$PROJECT_ID"

      - name: Wait for runner to be online with expected labels
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          echo "Waiting for self-hosted runner to register and come online..."

          # Poll up to ~2 minutes
          for i in {1..24}; do
            RUNNERS_JSON=$(curl -fsS \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runners")

            ONLINE_MATCHES=$(echo "${RUNNERS_JSON}" \
              | jq -r --arg labels "${EXPECTED_LABELS}" '
                  .runners
                  | map(select(.status=="online"))
                  | map(.labels | map(.name) | join(","))
                  | map(select(contains($labels)))
                  | length
                ')

            if [ "${ONLINE_MATCHES}" -gt 0 ]; then
              echo "Runner is registered and online with expected labels: ${EXPECTED_LABELS}"
              exit 0
            fi

            echo "Runner not online yet. Sleeping 5s..."
            sleep 5
          done

          echo "Runner failed to register within the timeout" >&2
          exit 1

  run-on-self-hosted:
    needs: start-runner
    runs-on: [self-hosted, linux, private]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Example job step
        run: |
          echo "Job is running on self-hosted runner $(hostname)"
          # Put your build/test/deploy steps here

  stop-runner:
    if: always()
    needs: run-on-self-hosted
    runs-on: ubuntu-latest
    steps:
      - name: Verify GCP auth inputs
        run: |
          if [ -z "${{ secrets.GCP_WORKLOAD_ID_PROVIDER }}" ] && [ -z "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" ]; then
            echo "No GCP auth inputs configured. Configure either GCP_WORKLOAD_ID_PROVIDER+GCP_SERVICE_ACCOUNT_EMAIL (OIDC) or GCP_SERVICE_ACCOUNT_KEY (service account JSON) in repository secrets." >&2
            exit 1
          fi

      - name: Authenticate to GCP (OIDC)
        if: ${{ secrets.GCP_WORKLOAD_ID_PROVIDER != '' && secrets.GCP_SERVICE_ACCOUNT_EMAIL != '' }}
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_ID_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
          create_credentials_file: true
          export_environment_variables: true
          access_token_scopes: https://www.googleapis.com/auth/cloud-platform
          access_token_lifetime: 3600s
          cleanup_credentials: true
          universe: googleapis.com

      - name: Authenticate to GCP (service account key)
        if: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY != '' }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          create_credentials_file: true
          export_environment_variables: true
          access_token_scopes: https://www.googleapis.com/auth/cloud-platform
          access_token_lifetime: 3600s
          cleanup_credentials: true
          universe: googleapis.com

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Stop instance (cleanup)
        run: |
          set -euo pipefail
          gcloud compute instances stop "$INSTANCE_NAME" --zone "$ZONE" --project "$PROJECT_ID"
