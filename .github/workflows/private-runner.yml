
name: GCP OIDC Auth & Ephemeral Runner Provision

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  actions: write
  id-token: write  # REQUIRED for OIDC

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

jobs:
  authenticate:
    name: Authenticate to GCP using OIDC
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Auth to Google Cloud via OIDC Workload Identity Federation
      - name: Determine GCP auth method
        id: choose-auth
        run: |
          if [ -n "${{ secrets.GCP_WORKLOAD_ID_PROVIDER }}" ] && [ -n "${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}" ]; then
            echo "auth_method=oidc" >> "$GITHUB_OUTPUT"
          elif [ -n "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" ]; then
            echo "auth_method=key" >> "$GITHUB_OUTPUT"
          else
            echo "No GCP auth inputs configured. Configure either GCP_WORKLOAD_ID_PROVIDER+GCP_SERVICE_ACCOUNT_EMAIL or GCP_SERVICE_ACCOUNT_KEY in repository secrets." >&2
            exit 1
          fi

      - name: Authenticate to GCP (OIDC)
        if: ${{ steps.choose-auth.outputs.auth_method == 'oidc' }}
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_ID_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
          create_credentials_file: true
          export_environment_variables: true
          access_token_scopes: https://www.googleapis.com/auth/cloud-platform
          access_token_lifetime: 3600s
          cleanup_credentials: true
          universe: googleapis.com

      - name: Authenticate to GCP (service account key)
        if: ${{ steps.choose-auth.outputs.auth_method == 'key' }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          create_credentials_file: true
          export_environment_variables: true
          access_token_scopes: https://www.googleapis.com/auth/cloud-platform
          access_token_lifetime: 3600s
          cleanup_credentials: true
          universe: googleapis.com

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify auth
        run: |
          gcloud info
          gcloud projects describe "${GCP_PROJECT_ID}"

  # (Optional) Provision your ephemeral runner VM via Terraform
  provision:
    name: Provision Ephemeral GCE Runner
    runs-on: ubuntu-latest
    needs: authenticate

    steps:
      - uses: actions/checkout@v4

      - name: Determine GCP auth method
        id: choose-auth
        run: |
          if [ -n "${{ secrets.GCP_WORKLOAD_ID_PROVIDER }}" ] && [ -n "${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}" ]; then
            echo "auth_method=oidc" >> "$GITHUB_OUTPUT"
          elif [ -n "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" ]; then
            echo "auth_method=key" >> "$GITHUB_OUTPUT"
          else
            echo "No GCP auth inputs configured. Configure GCP_WORKLOAD_ID_PROVIDER+GCP_SERVICE_ACCOUNT_EMAIL or GCP_SERVICE_ACCOUNT_KEY." >&2
            exit 1
          fi

      - name: Authenticate to GCP (OIDC)
        if: ${{ steps.choose-auth.outputs.auth_method == 'oidc' }}
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_ID_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
          create_credentials_file: true
          export_environment_variables: true
          access_token_scopes: https://www.googleapis.com/auth/cloud-platform
          access_token_lifetime: 3600s
          cleanup_credentials: true
          universe: googleapis.com

      - name: Authenticate to GCP (service account key)
        if: ${{ steps.choose-auth.outputs.auth_method == 'key' }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          create_credentials_file: true
          export_environment_variables: true
          access_token_scopes: https://www.googleapis.com/auth/cloud-platform
          access_token_lifetime: 3600s
          cleanup_credentials: true
          universe: googleapis.com

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform init
        working-directory: infra/gcp-runner
        env:
          TF_VAR_tf_state_bucket: ${{ secrets.GCS_TF_STATE_BUCKET }}
        run: terraform init

      - name: Terraform apply (create VM)
        id: tfapply
        working-directory: infra/gcp-runner
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: "asia-south1"
          TF_VAR_zone: "asia-south1-a"
          TF_VAR_repo_owner: "AnugulaSharathKumar"
          TF_VAR_repo_name: "Bilvanties_Task-3"
          TF_VAR_github_pat_secret: ${{ secrets.GITHUB_PAT_SECRET_NAME }} # Secret Manager name holding PAT (startup grabs registration token)
          TF_VAR_tf_state_bucket: ${{ secrets.GCS_TF_STATE_BUCKET }}
        run: |
          terraform apply -auto-approve
          echo "labels=$(terraform output -json runner_labels)" >> $GITHUB_OUTPUT

  # Your job that uses the ephemeral runner
  build:
    name: Run on self-hosted ephemeral runner
    needs: provision
    runs-on: [ self-hosted, gcp-gce, linux ]  # must match labels in startup.sh
    steps:
      - uses: actions/checkout@v4
      - run: |
          echo "Hello from ephemeral runner"
          uname -a

  # Always clean up the VM (even on failure)
  cleanup:
    name: Destroy runner VM
    needs: [ authenticate, provision, build ]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Determine GCP auth method
        id: choose-auth
        run: |
          if [ -n "${{ secrets.GCP_WORKLOAD_ID_PROVIDER }}" ] && [ -n "${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}" ]; then
            echo "auth_method=oidc" >> "$GITHUB_OUTPUT"
          elif [ -n "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" ]; then
            echo "auth_method=key" >> "$GITHUB_OUTPUT"
          else
            echo "No GCP auth inputs configured. Configure GCP_WORKLOAD_ID_PROVIDER+GCP_SERVICE_ACCOUNT_EMAIL or GCP_SERVICE_ACCOUNT_KEY." >&2
            exit 1
          fi

      - name: Authenticate to GCP (OIDC)
        if: ${{ steps.choose-auth.outputs.auth_method == 'oidc' }}
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_ID_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
          create_credentials_file: true
          export_environment_variables: true
          access_token_scopes: https://www.googleapis.com/auth/cloud-platform
          access_token_lifetime: 3600s
          cleanup_credentials: true
          universe: googleapis.com

      - name: Authenticate to GCP (service account key)
        if: ${{ steps.choose-auth.outputs.auth_method == 'key' }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          create_credentials_file: true
          export_environment_variables: true
          access_token_scopes: https://www.googleapis.com/auth/cloud-platform
          access_token_lifetime: 3600s
          cleanup_credentials: true
          universe: googleapis.com

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform destroy
        working-directory: infra/gcp-runner
        env:
          TF_VAR_tf_state_bucket: ${{ secrets.GCS_TF_STATE_BUCKET }}
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
        run: terraform destroy -auto-approve
