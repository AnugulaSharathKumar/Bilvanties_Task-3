name: GCP Self Hosted Runner â€“ Full Lifecycle

on:
  push:
    branches:
      - main

jobs:
  name: Deploy GitHub Runner on GCP

  on:
    workflow_dispatch:
      inputs:
        runner_token:
          description: 'Optional runner token (falls back to secret RUNNER_TOKEN)'
          required: false
          default: ''

  jobs:
    terraform:
      runs-on: self-hosted
      permissions:
        contents: read
        id-token: write

      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Setup Google Cloud SDK
          uses: google-github-actions/setup-gcloud@v1
          with:
            service_account_key: ${{ secrets.GCP_CREDENTIALS }}
            project_id: my-learning-terraform-482905

        - name: Install Terraform
          uses: hashicorp/setup-terraform@v2
          with:
            terraform_version: 1.5.7

        - name: Configure runner token
          run: |
            if [ -n "${{ github.event.inputs.runner_token }}" ]; then
              echo "TF_VAR_runner_token=${{ github.event.inputs.runner_token }}" >> $GITHUB_ENV
            else
              echo "TF_VAR_runner_token=${{ secrets.RUNNER_TOKEN }}" >> $GITHUB_ENV
            fi

        - name: Terraform Init
          working-directory: .
          run: terraform init -input=false

        - name: Terraform Plan
          working-directory: .
          run: terraform plan -input=false

        - name: Terraform Apply
          if: github.event.inputs.runner_token != '' || secrets.RUNNER_TOKEN != ''
          working-directory: .
          run: terraform apply -auto-approve -input=false
