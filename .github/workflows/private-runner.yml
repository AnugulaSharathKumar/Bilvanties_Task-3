name: Private Runner Setup
on:
  workflow_dispatch:

# Actions API calls + repository access for ${ { github.token } }
permissions:
  actions: write
  contents: read

jobs:
  start_runner_vm:
    runs-on: ubuntu-latest
    outputs:
      runner_token: ${{ steps.regtoken.outputs.token }}
    steps:
      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Create GitHub runner registration token
        id: regtoken
        env:
          GH_TOKEN: ${{ github.token }}   # use the workflow's token (repo-scoped to this repo)
        run: |
          set -euo pipefail
          echo "Requesting registration token for ${{ github.repository }}"
          : "${GH_TOKEN:?GH_TOKEN is not set}"

          HTTP_BODY=$(curl -sS -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${GH_TOKEN}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "https://api.github.com/repos/${{ github.repository }}/actions/runners/registration-token" \
          -w "\n%{http_code}")

          HTTP_CODE=$(echo "$HTTP_BODY" | tail -n1)
          TOKEN_JSON=$(echo "$HTTP_BODY" | sed '$d')

          if [ "$HTTP_CODE" != "201" ]; then
          echo "Failed to get registration token (HTTP $HTTP_CODE)" >&2
          echo "Response: $TOKEN_JSON" >&2
          exit 1
           fi
      - name: Update VM metadata (github_url + runner_token)
        run: |
          gcloud compute instances add-metadata "${{ secrets.RUNNER_INSTANCE_NAME }}" \
            --project "${{ secrets.GCP_PROJECT_ID }}" \
            --zone "${{ secrets.GCP_ZONE }}" \
            --metadata=github_url="https://github.com/${{ github.repository }}",runner_token="${{ steps.regtoken.outputs.token }}" \
            --quiet

      - name: Start VM
        run: |
          gcloud compute instances start "${{ secrets.RUNNER_INSTANCE_NAME }}" \
            --project "${{ secrets.GCP_PROJECT_ID }}" \
            --zone "${{ secrets.GCP_ZONE }}" \
            --quiet

      - name: Wait for runner to register (online + labels)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          echo "Waiting for private runner to register..."

          EXPECTED_LABELS="self-hosted,private,ubuntu,linux,gcp"

          for i in {1..24}; do  # up to ~2 minutes
            RUNNERS_JSON=$(curl -fsS \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runners")

            ONLINE_MATCHES=$(echo "${RUNNERS_JSON}" \
              | jq -r --arg labels "$EXPECTED_LABELS" '
                  .runners
                  | map(select(.status=="online"))
                  | map(.labels | map(.name) | join(","))
                  | map(select(contains($labels)))
                  | length
                ')

            if [ "${ONLINE_MATCHES}" -gt 0 ]; then
              echo "Runner is registered and online with expected labels!"
              exit 0
            fi

            echo "Not registered yet. Waiting 5 seconds..."
            sleep 5
          done

          echo "Runner failed to register in time." >&2
          exit 1

  run_job_on_private_runner:
    needs: start_runner_vm
    runs-on: [self-hosted, private, ubuntu, linux, gcp]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify runner
        run: |
          echo "Hello from private runner"
          hostname
          uname -a

      - name: Start application / job
        run: |
          echo "Starting application..."
          # docker compose up -d
          # ./start-app.sh

      - name: Main job
        run: |
          echo "Running main job..."
          sleep 15
          echo "Job completed."

  stop_runner_vm:
    if: always()
    needs: run_job_on_private_runner
    runs-on: ubuntu-latest
    steps:
      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Stop VM (safety cleanup)
        run: |
          gcloud compute instances stop "${{ secrets.RUNNER_INSTANCE_NAME }}" \
            --project "${{ secrets.GCP_PROJECT_ID }}" \
            --zone "${{ secrets.GCP_ZONE }}" \
            --quiet