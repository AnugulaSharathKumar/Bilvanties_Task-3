name: GCP Private Ubuntu Runner (On Demand)

on:
  workflow_dispatch:

permissions:
  actions: write

jobs:
  start_runner_vm:
    runs-on: ubuntu-latest
    outputs:
      runner_token: ${{ steps.regtoken.outputs.token }}
    steps:
      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Create GitHub runner registration token
        id: regtoken
        run: |
          set -euo pipefail
          TOKEN=$(curl -fsS -X POST \
            -H "Authorization: Bearer ${{ secrets.MY_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/runners/registration-token \
            | jq -r .token)
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "Failed to get registration token" >&2
            exit 1
          fi
          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"

      - name: Update VM metadata (github_url + runner_token)
        run: |
          gcloud compute instances add-metadata "${{ secrets.RUNNER_INSTANCE_NAME }}" \
            --project "${{ secrets.GCP_PROJECT_ID }}" \
            --zone "${{ secrets.GCP_ZONE }}" \
            --metadata=github_url="https://github.com/${{ github.repository }}",runner_token="${{ steps.regtoken.outputs.token }}" \
            --quiet

      - name: Start VM
        run: |
          gcloud compute instances start "${{ secrets.RUNNER_INSTANCE_NAME }}" \
            --project "${{ secrets.GCP_PROJECT_ID }}" \
            --zone "${{ secrets.GCP_ZONE }}" \
            --quiet

      - name: Wait for runner to register
        run: |
          echo "Waiting for private runner to register..."
          for i in {1..12}; do
            RUNNERS=$(curl -fsS -H "Authorization: Bearer ${{ secrets.MY_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/${{ github.repository }}/actions/runners | jq '.runners | length')
            if [ "$RUNNERS" -gt 0 ]; then
              echo "Runner is registered!"
              exit 0
            fi
            echo "Waiting 5 seconds..."
            sleep 5
          done
          echo "Runner failed to register in time." >&2
          exit 1

  run_job_on_private_runner:
    needs: start_runner_vm
    runs-on: [self-hosted, private, ubuntu, linux, gcp]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify runner
        run: |
          echo "Hello from private runner"
          hostname
          uname -a

      - name: Start application / job
        run: |
          echo "Starting application..."
          # Example:
          # docker compose up -d
          # ./start-app.sh

      - name: Main job
        run: |
          echo "Running main job..."
          sleep 15
          echo "Job completed."

  stop_runner_vm:
    if: always()
    needs: run_job_on_private_runner
    runs-on: ubuntu-latest
    steps:
      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Stop VM (safety cleanup)
        run: |
          gcloud compute instances stop "${{ secrets.RUNNER_INSTANCE_NAME }}" \
            --project "${{ secrets.GCP_PROJECT_ID }}" \
            --zone "${{ secrets.GCP_ZONE }}" \
            --quiet
