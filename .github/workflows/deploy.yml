name: GCP Self Hosted Runner â€“ Full Lifecycle

on:
  push:
    branches:
      - main

jobs:
  deploy:
    # ====================================================
    # JOB TIMEOUT
    # Purpose:
    # - Prevent infinite waiting for runner
    # - Auto-cancel job if runner not picked or hangs
    # ====================================================
    timeout-minutes: 15

    # ====================================================
    # RUNNER SELECTION
    # Must match labels registered in startup.sh
    # ====================================================
    runs-on: [self-hosted, gcp]

    steps:

      # ====================================================
      # STEP 1: PIPELINE START CONFIRMATION
      # ====================================================
      - name: STEP 1 - Pipeline Started
        run: |
          echo "===================================="
          echo "$(date) : Pipeline started"
          echo "Runner Hostname: $(hostname)"
          echo "Runner User: $(whoami)"
          echo "===================================="


      # ====================================================
      # STEP 2: CHECKOUT SOURCE CODE
      # ====================================================
      - name: STEP 2 - Checkout Repository
        uses: actions/checkout@v4


      # ====================================================
      # STEP 3: DEPLOY APPLICATION
      # ====================================================
      - name: STEP 3 - Deploy Application (NGINX)
        run: |
          echo "$(date) : Restarting NGINX"
          sudo systemctl restart nginx
          sudo systemctl status nginx


      # ====================================================
      # STEP 4: VERIFY APPLICATION
      # ====================================================
      - name: STEP 4 - Verify Application
        run: |
          echo "$(date) : Verifying NGINX response"
          curl -I http://localhost


      # ====================================================
      # STEP 5: SHUTDOWN VM (COST SAVING)
      # ====================================================
      - name: STEP 5 - Shutdown Runner VM
        run: |
          echo "===================================="
          echo "$(date) : Pipeline completed successfully"
          echo "$(date) : Shutting down VM"
          echo "===================================="
          sudo shutdown -h now
